name: 🧪 Run Python Tests (Poetry)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false # Don't cancel other matrix jobs if one fails
      matrix:
        # Based on your poetry.lock, Python >=3.9 is required.
        # Python 3.12 is the current stable.
        # Python 3.13 has wheels in your lock, so it's likely compatible.
        # Let's start with stable and add 3.13 as optional for troubleshooting.
        python-version: ["3.9", "3.10", "3.11", "3.12"]
        # Add 3.13 back if the other versions work, using allow-prereleases
        # python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"] # if you want to test 3.13

    steps:
    - name: ⬇️ Checkout code
      uses: actions/checkout@v4

    - name: 🐍 Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        # Keep this line if you decide to include '3.13' in python-version matrix
        # allow-prereleases: true
        cache: 'poetry' # Cache Python dependencies

    - name: 📦 Install Poetry (attempt 1: via action with version)
      # Try to get snok/install-poetry to install 2.1.3
      # Note: snok/install-poetry@v1 primarily supports Poetry 1.x by its 'version' input.
      # It might not successfully install Poetry 2.x.
      # This step might fail if it can't find/install Poetry 2.x.
      uses: snok/install-poetry@v1
      with:
        version: 2.1.3 # This is the version from your poetry.lock
        virtualenvs-create: true
        virtualenvs-in-project: true
        virtualenvs-path: .venv
        installer-parallel: true
      continue-on-error: true # Allow this step to fail and try the next approach

    - name: 📦 Install Poetry (attempt 2: direct install if action failed for 2.x)
      # This step will only run if the previous 'Install Poetry' step failed (due to continue-on-error)
      # Or if you comment out the previous step entirely if you know snok doesn't support 2.x
      if: steps.install_poetry_attempt1.outcome == 'failure' || steps.install_poetry_attempt1.outcome == 'skipped'
      run: |
        # Use the official Poetry installer script directly for Poetry 2.x
        # This is the most reliable way to get a specific Poetry 2.x version.
        curl -sSL https://install.python-poetry.org | python3 - --version 2.1.3
        echo "POETRY_HOME=$(poetry env info -p)" >> $GITHUB_ENV
        echo "$(poetry env info -b)/bin" >> $GITHUB_PATH
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true
        poetry config virtualenvs.path .venv

    - name: 🧰 Install dependencies
      # Now that Poetry 2.1.3 is hopefully installed, install dependencies
      run: poetry install --no-interaction --no-ansi

    - name: 🧪 Run tests
      run: poetry run pytest